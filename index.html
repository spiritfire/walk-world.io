<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Walk World V14</title>
    <style>
        /* --- Global / ÂÖ®Â±Ä --- */
        body, html { margin:0; padding:0; width:100%; height:100%; background:#000; overflow:hidden; font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; user-select:none; -webkit-tap-highlight-color:transparent; color:white; }
        
        /* Video Layer / ËßÜÈ¢ëÂ±Ç */
        #v-wrap { position:absolute; top:0; left:0; width:100%; height:100%; z-index:1; display:flex; align-items:center; justify-content:center; }
        /* ÂÖ≥ÈîÆÔºöÂ¢ûÂä† will-change ‰ºòÂåñÊÄßËÉΩ */
        video { width:100%; height:100%; object-fit:cover; will-change:transform; }

        /* UI Layer / ÁïåÈù¢Â±Ç */
        #ui { position:absolute; top:0; left:0; width:100%; height:100%; z-index:10; pointer-events:none; display:flex; flex-direction:column; justify-content:space-between; text-shadow:0 1px 4px rgba(0,0,0,0.9); }
        
        /* Top Bar / È°∂ÈÉ® */
        .top { padding:20px; display:flex; justify-content:space-between; align-items:flex-start; }
        .grp { display:flex; flex-direction:column; }
        .grp-r { text-align:right; align-items:flex-end; }
        
        .txt-main { font-size:52px; font-weight:800; line-height:0.9; font-variant-numeric:tabular-nums; }
        .txt-lbl { font-size:12px; font-weight:700; color:#ccc; margin-top:5px; text-transform:uppercase; letter-spacing:1px; }
        .txt-sub { font-size:16px; font-weight:700; color:#00e676; margin-top:5px; }

        /* Dot / ÂëºÂê∏ÁÇπ */
        .dot { display:inline-block; width:10px; height:10px; background:#444; border-radius:50%; margin-right:6px; border:1px solid #888; transition:0.1s; }
        .dot.lit { background:#00e676; box-shadow:0 0 12px #00e676; border-color:#fff; transform:scale(1.4); }

        /* Bottom Bar / Â∫ïÈÉ® */
        .btm { padding:20px; pointer-events:auto; background:linear-gradient(to top, rgba(0,0,0,0.9), transparent); }
        .bar-bg { width:100%; height:6px; background:rgba(255,255,255,0.3); border-radius:3px; overflow:hidden; backdrop-filter:blur(5px); }
        .bar-fg { width:0%; height:100%; background:#00e676; box-shadow:0 0 15px rgba(0,230,118,0.6); transition:width 0.2s linear; }
        .tm { display:flex; justify-content:space-between; font-size:12px; margin-bottom:8px; font-weight:600; opacity:0.9; }
        
        .btn-row { display:flex; justify-content:space-between; margin-top:15px; gap:10px; }

        /* Settings Drawer / ËÆæÁΩÆÊäΩÂ±â */
        #set { position:absolute; bottom:0; left:0; width:100%; background:rgba(18,18,18,0.98); border-top:1px solid #333; border-radius:24px 24px 0 0; padding:25px; box-sizing:border-box; transform:translateY(110%); transition:transform 0.3s cubic-bezier(0.1, 0.7, 0.1, 1); z-index:20; pointer-events:auto; }
        #set.show { transform:translateY(0); }
        
        .row { margin-bottom:20px; }
        .rh { display:flex; justify-content:space-between; margin-bottom:10px; font-size:14px; color:#aaa; font-weight:600; }
        .rv { color:#00e676; }
        input[type=range] { width:100%; height:6px; background:#333; border-radius:3px; -webkit-appearance:none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; width:22px; height:22px; background:#fff; border-radius:50%; box-shadow:0 2px 6px rgba(0,0,0,0.5); }
        
        .tgl-row { display:flex; align-items:center; justify-content:space-between; margin-bottom:15px; font-size:14px; color:#ddd; font-weight:600; }
        .tgl { width:46px; height:26px; background:#444; border-radius:13px; position:relative; transition:0.3s; cursor:pointer; }
        .tgl::after { content:''; position:absolute; top:2px; left:2px; width:22px; height:22px; background:#fff; border-radius:50%; transition:0.3s; }
        .tgl.on { background:#00e676; }
        .tgl.on::after { left:22px; }

        /* Lang Button */
        .lang-btn { position:absolute; top:20px; right:20px; background:rgba(255,255,255,0.1); border:1px solid #555; color:#fff; padding:5px 10px; font-size:12px; border-radius:15px; cursor:pointer; z-index:101; }

        /* Boot Screen / ÂêØÂä®È°µ */
        #boot { position:absolute; top:0; left:0; width:100%; height:100%; background:#050505; z-index:99; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; }
        .btn { padding:15px 40px; border-radius:50px; font-size:16px; font-weight:700; border:none; margin:10px; cursor:pointer; transition:transform 0.1s; }
        .btn:active { transform:scale(0.95); }
        .btn-g { background:#00e676; color:#000; box-shadow:0 0 15px rgba(0,230,118,0.2); }
        .btn-b { background:#2979FF; color:#fff; }
        .btn-s { flex:1; background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.2); color:#fff; padding:10px; font-size:13px; border-radius:16px; backdrop-filter:blur(10px); }
        
        .warn { font-size:12px; color:#666; margin-top:20px; max-width:80%; line-height:1.5; }

    </style>
</head>
<body>

    <!-- Language Switcher -->
    <button class="lang-btn" onclick="toggleLang()">‰∏≠ / En</button>

    <!-- Boot Screen -->
    <div id="boot">
        <h1 style="color:#00e676; margin-bottom:5px;" data-t="title">Walk World V14</h1>
        <p style="color:#888; font-size:12px; margin-bottom:40px; letter-spacing:1px;" data-t="subtitle">Anti-Shake VR ‚Ä¢ Bilingual ‚Ä¢ Stable</p>
        
        <button class="btn btn-b" onclick="document.getElementById('fi').click()" data-t="btnSel">1. Select Video</button>
        <input type="file" id="fi" accept="video/*" style="display:none" onchange="onF(this)">
        <div id="fn" style="color:#00e676; font-size:12px; height:20px; margin-bottom:5px;"></div>
        
        <button id="go" class="btn btn-g" onclick="start()" disabled style="opacity:0.3" data-t="btnGo">2. Start Fullscreen</button>
        
        <div class="warn" data-t="tip">Note: Please run in HTTPS or Localhost for sensor access.</div>
    </div>

    <!-- Video -->
    <div id="v-wrap"><video id="vid" playsinline loop muted webkit-playsinline></video></div>

    <!-- HUD -->
    <div id="ui" style="display:none">
        <div class="top">
            <div class="grp">
                <div class="txt-main" id="d-spd">0.0</div>
                <div class="txt-lbl" data-t="lblSpeed">Speed km/h</div>
                <div class="txt-sub" id="d-rat">0.00 x</div>
            </div>
            <div class="grp grp-r">
                <div class="txt-main" id="d-stp">0</div>
                <div class="txt-lbl"><span class="dot" id="dot"></span><span data-t="lblSteps">Steps</span></div>
                <div class="txt-sub" id="d-dst">0.00 km</div>
            </div>
        </div>
        <div class="btm">
            <div class="tm"><span id="tc">0:00</span><span id="tt">0:00</span></div>
            <div class="bar-bg"><div class="bar-fg" id="pb"></div></div>
            
            <div class="btn-row">
                <button class="btn-s" onclick="recenter()" data-t="btnCenter">üéØ Recenter</button>
                <button class="btn-s" onclick="tSet()" data-t="btnSet">‚öôÔ∏è Settings</button>
            </div>
        </div>
    </div>

    <!-- Settings -->
    <div id="set">
        <div style="display:flex;justify-content:space-between;margin-bottom:25px;align-items:center;">
            <h3 style="margin:0" data-t="headSet">Settings</h3>
            <span onclick="tSet()" style="font-size:28px;color:#666;cursor:pointer;">√ó</span>
        </div>

        <div class="row"><div class="rh"><span data-t="cfgBase">Video Base Speed</span><span class="rv" id="vb">5 km/h</span></div><input type="range" min="2" max="15" value="5" oninput="uC('base',this.value)"></div>
        <div class="row"><div class="rh"><span data-t="cfgStride">Stride Length</span><span class="rv" id="vs">0.70 m</span></div><input type="range" min="0.4" max="1.2" step="0.05" value="0.7" oninput="uC('stride',this.value)"></div>
        <div class="row"><div class="rh"><span data-t="cfgSens">Sensitivity (Low=High)</span><span class="rv" id="vse">1.3</span></div><input type="range" min="0.8" max="3.0" step="0.1" value="1.3" oninput="uC('sens',this.value)"></div>
        
        <div style="height:1px; background:#333; margin:20px 0;"></div>
        
        <div class="tgl-row" onclick="uT('vrInv')">
            <span data-t="cfgInv">üîÑ Invert VR Direction</span>
            <div class="tgl" id="t-vr"></div>
        </div>

        <div style="text-align:center; margin-top:20px;">
             <button class="btn-s" style="width:100%; border-color:#00e676; color:#00e676;" onclick="sim()" data-t="btnSim">‚ö° Sim Step (Test)</button>
        </div>
    </div>

    <script>
        // --- Translations ---
        const TR = {
            zh: {
                title: "Êº´Ê≠•‰∏ñÁïå V14", subtitle: "Êô∫ËÉΩÈò≤Êäñ VR ¬∑ ‰∏≠Ëã±ÂèåËØ≠ ¬∑ ÂÆåÁæéÁâà",
                btnSel: "1. ÈÄâÊã©ËßÜÈ¢ë", btnGo: "2. ÂÖ®Â±èÂá∫Âèë", tip: "ÊèêÁ§∫ÔºöÈúÄË¶Å HTTPS ÁéØÂ¢ÉÊàñÊú¨Âú∞ localhost ÊâçËÉΩË∞ÉÁî®‰º†ÊÑüÂô®„ÄÇ",
                lblSpeed: "Êó∂ÈÄü km/h", lblSteps: "Ê≠•Êï∞",
                btnCenter: "üéØ ÂõûÊ≠£ËßÜËßí", btnSet: "‚öôÔ∏è ËÆæÁΩÆ",
                headSet: "ËøêÂä®ËÆæÁΩÆ", cfgBase: "ÂéüËßÜÈ¢ëÈÄüÂ∫¶", cfgStride: "ÊàëÁöÑÊ≠•Èïø", cfgSens: "ÁÅµÊïèÂ∫¶ (Ë∂äÂ∞èË∂äÁÅµÊïè)",
                cfgInv: "üîÑ VR ÊñπÂêëÂèçËΩ¨", btnSim: "‚ö° Ê®°ÊãüËµ∞‰∏ÄÊ≠• (ÊµãËØï)"
            },
            en: {
                title: "Walk World V14", subtitle: "Anti-Shake VR ‚Ä¢ Bilingual ‚Ä¢ Stable",
                btnSel: "1. Select Video", btnGo: "2. Start Fullscreen", tip: "Note: HTTPS or Localhost required for sensor access.",
                lblSpeed: "Speed km/h", lblSteps: "Steps",
                btnCenter: "üéØ Recenter", btnSet: "‚öôÔ∏è Settings",
                headSet: "Settings", cfgBase: "Video Base Speed", cfgStride: "Stride Length", cfgSens: "Sensitivity (Lower=Higher)",
                cfgInv: "üîÑ Invert VR Direction", btnSim: "‚ö° Sim Step (Test)"
            }
        };
        let CUR_LANG = 'zh'; // Default Chinese

        // --- Config & State ---
        const C = { base:5, stride:0.7, sens:1.3, vr:25, vrInv:false };
        const S = { 
            run:false, steps:0, lastT:0, hist:[], curr:0, target:0, 
            land:false, alpha0:null,
            // VR Stabilization
            vrTarget: 0, // Where we want to go
            vrCurr: 0    // Where we are (smoothed)
        };
        
        const vid = document.getElementById('vid');
        const dot = document.getElementById('dot');
        let ac; 

        // Apply Language immediately
        applyLang();

        function toggleLang() {
            CUR_LANG = CUR_LANG === 'zh' ? 'en' : 'zh';
            applyLang();
        }

        function applyLang() {
            const t = TR[CUR_LANG];
            document.querySelectorAll('[data-t]').forEach(el => {
                const k = el.getAttribute('data-t');
                if(t[k]) el.innerText = t[k];
            });
        }

        function onF(el) {
            const f=el.files[0]; if(!f)return;
            vid.src=URL.createObjectURL(f);
            document.getElementById('fn').innerText=f.name;
            document.getElementById('go').disabled=false;
            document.getElementById('go').style.opacity=1;
            vid.onloadedmetadata = () => {
                S.land = vid.videoWidth > vid.videoHeight;
                if(S.land) { vid.style.width='auto'; vid.style.height='100vh'; } 
                else { vid.style.width='100%'; vid.style.height='100%'; }
            };
        }

        function start() {
            if(document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
            document.getElementById('boot').style.display='none';
            document.getElementById('ui').style.display='flex';
            ac = new (window.AudioContext||window.webkitAudioContext)();
            if(window.DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission==='function') {
                DeviceMotionEvent.requestPermission().then(r=>{if(r==='granted')init();});
            } else init();
            vid.play().then(()=>vid.pause());
            S.run=true;
            requestAnimationFrame(loop);
        }

        function init() {
            window.addEventListener('devicemotion', mot);
            window.addEventListener('deviceorientation', ori);
        }

        function mot(e) {
            const a = e.accelerationIncludingGravity || e.acceleration;
            if(!a) return;
            const v = Math.sqrt(a.x**2 + a.y**2 + a.z**2);
            if(Math.abs(v - 9.8) > C.sens) trig();
        }

        function trig() {
            const now = Date.now();
            const diff = now - S.lastT;
            if(diff < 250) return;

            dot.classList.add('lit');
            setTimeout(()=>dot.classList.remove('lit'), 100);
            fb(); 

            S.steps++;
            
            if (diff > 1200) {
                // Cold Start
                const startSPM = 80; 
                S.hist = [startSPM];
                const kmh = (startSPM * C.stride * 60) / 1000;
                S.target = kmh / C.base;
                if(S.curr < 0.1) S.curr = S.target * 0.6; 
            } else {
                // Continuous
                const spm = 60000 / diff;
                S.hist.push(spm);
                if(S.hist.length > 3) S.hist.shift();
                let sum = 0; S.hist.forEach(v=>sum+=v);
                const avgSPM = sum / S.hist.length;
                const kmh = (avgSPM * C.stride * 60) / 1000;
                S.target = kmh / C.base;
            }
            S.lastT = now;
        }

        function loop() {
            if(!S.run) return;

            // Auto Stop
            if(Date.now() - S.lastT > 1200) S.target = 0;

            // Smooth Speed
            const d = S.target - S.curr;
            if(Math.abs(d) > 0.001) S.curr += d * 0.1;
            else S.curr = S.target;

            // Prevent Stall < 0.08
            if(S.curr < 0.08) {
                S.curr = 0;
                if(!vid.paused) vid.pause();
            } else {
                vid.playbackRate = S.curr;
                if(vid.paused) vid.play().catch(()=>{});
            }

            // === VR Smoothing (Low-Pass Filter) ===
            // This is the key to preventing motion sickness
            if (S.land) {
                const vrDiff = S.vrTarget - S.vrCurr;
                // 0.1 is the smoothing factor. Lower = smoother but slower.
                if (Math.abs(vrDiff) > 0.05) {
                    S.vrCurr += vrDiff * 0.1; 
                } else {
                    S.vrCurr = S.vrTarget;
                }
                vid.style.transform = `translateX(${S.vrCurr}%)`;
            }

            draw();
            requestAnimationFrame(loop);
        }

        function draw() {
            const kmh = S.curr * C.base;
            document.getElementById('d-spd').innerText = kmh.toFixed(1);
            document.getElementById('d-rat').innerText = S.curr.toFixed(2)+" x";
            document.getElementById('d-stp').innerText = S.steps;
            document.getElementById('d-dst').innerText = ((S.steps*C.stride)/1000).toFixed(2)+" km";
            if(vid.duration) {
                document.getElementById('pb').style.width = (vid.currentTime/vid.duration*100)+"%";
                document.getElementById('tc').innerText = fmt(vid.currentTime);
                document.getElementById('tt').innerText = fmt(vid.duration);
            }
        }

        function ori(e) {
            if(!S.land || !e.alpha) return;
            if(S.alpha0 === null) S.alpha0 = e.alpha;
            
            let d = e.alpha - S.alpha0;
            if(d > 180) d -= 360; if(d < -180) d += 360;
            d = Math.max(-C.vr, Math.min(C.vr, d));
            
            // Reduced sensitivity (0.4) for comfort
            let move = d * 0.4; 
            if(C.vrInv) move = move * -1;
            
            // Instead of setting transform directly, we set the TARGET
            S.vrTarget = move;
        }
        
        function recenter() {
            S.alpha0 = null;
            S.vrTarget = 0; // Reset target immediately
        }

        function fb() {
            if(navigator.vibrate) navigator.vibrate(15);
            if(ac && ac.state==='running') {
                const o=ac.createOscillator(), g=ac.createGain();
                o.connect(g); g.connect(ac.destination);
                o.frequency.setValueAtTime(120, ac.currentTime);
                o.frequency.exponentialRampToValueAtTime(0.01, ac.currentTime+0.1);
                g.gain.setValueAtTime(0.2, ac.currentTime);
                g.gain.exponentialRampToValueAtTime(0.01, ac.currentTime+0.1);
                o.start(); o.stop(ac.currentTime+0.1);
            }
        }

        function tSet() { document.getElementById('set').classList.toggle('show'); }
        function uC(k,v) { 
            v=parseFloat(v); C[k]=v;
            if(k==='base')document.getElementById('vb').innerText=v+" km/h";
            if(k==='stride')document.getElementById('vs').innerText=v.toFixed(2)+" m";
            if(k==='sens')document.getElementById('vse').innerText=v;
        }
        function uT(k) {
            C[k] = !C[k];
            if(k==='vrInv') document.getElementById('t-vr').classList.toggle('on');
        }
        function fmt(s) { return Math.floor(s/60)+":"+(Math.floor(s%60)<10?'0':'')+Math.floor(s%60); }
        function sim() { trig(); }
    </script>
</body>
</html>
