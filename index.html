<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥èº«æ¼«æ­¥ V3 - å¼ºåŠ¨åŠ›ç‰ˆ</title>
    <style>
        /* --- å…¨å±€æ ·å¼ --- */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: #000; overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: white; user-select: none; -webkit-tap-highlight-color: transparent;
        }

        /* è§†é¢‘å±‚ */
        #video-wrapper {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        video {
            width: 100%; height: 100%; object-fit: cover;
            transform-origin: center center;
            will-change: transform; /* æ€§èƒ½ä¼˜åŒ– */
        }

        /* UIå±‚ */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        /* é¡¶éƒ¨ HUD */
        .hud-top {
            padding: 15px; display: flex; justify-content: space-between;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        }
        .speed-box { text-align: left; }
        .step-box { text-align: right; }
        .big-text { font-size: 36px; font-weight: 800; text-shadow: 0 2px 4px rgba(0,0,0,0.5); font-variant-numeric: tabular-nums;}
        .label { font-size: 12px; opacity: 0.8; text-transform: uppercase; }

        /* ä¼ æ„Ÿå™¨æŒ‡ç¤ºç¯ */
        .sensor-indicator {
            display: inline-block; width: 12px; height: 12px; border-radius: 50%;
            background: #333; margin-right: 5px; border: 1px solid #555;
            transition: background 0.1s;
        }
        .sensor-active { background: #00ff00; box-shadow: 0 0 8px #00ff00; }

        /* åº•éƒ¨æ§åˆ¶æ  */
        .hud-bottom {
            padding: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            pointer-events: auto; /* å…è®¸ç‚¹å‡» */
        }
        
        /* è¿›åº¦æ¡ */
        .progress-track {
            width: 100%; height: 6px; background: rgba(255,255,255,0.2);
            border-radius: 3px; margin-bottom: 15px; overflow: hidden;
        }
        .progress-fill {
            height: 100%; width: 0%; background: #00e676;
            transition: width 0.2s linear;
        }

        /* æŒ‰é’® */
        .btn {
            background: #333; border: 1px solid #555; color: white;
            padding: 10px 20px; border-radius: 30px; font-size: 14px;
            margin-right: 10px; cursor: pointer;
        }
        .btn-primary { background: #00e676; color: black; border: none; font-weight: bold; }
        .btn-settings { width: 100%; margin-top: 10px; background: rgba(255,255,255,0.1); }

        /* è®¾ç½®é¢æ¿ */
        #settings-panel {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: #1a1a1a; border-top-left-radius: 20px; border-top-right-radius: 20px;
            padding: 20px; box-sizing: border-box; transform: translateY(110%);
            transition: transform 0.3s ease-out; z-index: 20; pointer-events: auto;
        }
        #settings-panel.show { transform: translateY(0); }

        .control-row { margin-bottom: 20px; }
        .control-row label { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; color: #ccc; }
        .control-row input[type=range] { width: 100%; height: 6px; background: #444; border-radius: 3px; outline: none; -webkit-appearance: none; }
        .control-row input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: #00e676; border-radius: 50%; }

        /* å¯åŠ¨é®ç½© */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 50; display: flex; flex-direction: column;
            align-items: center; justify-content: center; text-align: center;
        }
    </style>
</head>
<body>

    <!-- 1. å¯åŠ¨å±å¹• -->
    <div id="start-screen">
        <h1 style="color:#00e676; margin-bottom: 10px;">ğŸƒ å¥èº«æ¼«æ­¥ V3</h1>
        <p style="color:#888; font-size: 13px; max-width: 80%; margin-bottom: 30px;">
            ä¿®å¤ï¼šå¢åŠ æ¯æ­¥åŠ¨åŠ›è®¾ç½®<br>ä¿®å¤ï¼šå®‰å“è§†é¢‘å¡é¡¿é—®é¢˜
        </p>
        
        <button class="btn" onclick="document.getElementById('videoFile').click()" style="padding: 15px 40px; font-size: 16px;">
            ğŸ“‚ ç¬¬ä¸€æ­¥ï¼šé€‰æ‹©è§†é¢‘
        </button>
        <input type="file" id="videoFile" accept="video/*" style="display:none" onchange="handleFile(this)">
        
        <div id="file-status" style="margin: 15px 0; font-size: 12px; color: #00e676; min-height: 20px;"></div>

        <button id="go-btn" class="btn btn-primary" onclick="startGame()" disabled style="padding: 15px 40px; font-size: 18px; opacity: 0.5;">
            ğŸš€ ç¬¬äºŒæ­¥ï¼šå¼€å§‹è¿åŠ¨
        </button>
    </div>

    <!-- 2. è§†é¢‘å®¹å™¨ -->
    <div id="video-wrapper">
        <video id="mainVideo" playsinline loop muted webkit-playsinline></video>
    </div>

    <!-- 3. ä¸»ç•Œé¢ (HUD) -->
    <div id="ui-layer" style="display:none;">
        <div class="hud-top">
            <div class="speed-box">
                <div class="label">æ’­æ”¾å€é€Ÿ</div>
                <div class="big-text" id="disp-rate">0.0</div>
                <div class="label" id="disp-kmh" style="color:#00e676">0 km/h</div>
            </div>
            <div class="step-box">
                <div class="label">æ­¥æ•° <span class="sensor-indicator" id="sensor-dot"></span></div>
                <div class="big-text" id="disp-steps">0</div>
                <div class="label" id="status-text">æš‚åœä¸­</div>
            </div>
        </div>

        <div class="hud-bottom">
            <div class="progress-track">
                <div class="progress-fill" id="progress-bar"></div>
            </div>
            <button class="btn btn-settings" onclick="toggleSettings()">âš™ï¸ è°ƒæ•´å‚æ•° / è°ƒè¯•</button>
        </div>
    </div>

    <!-- 4. è®¾ç½®ä¸è°ƒè¯•é¢æ¿ -->
    <div id="settings-panel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h3 style="margin:0">âš™ï¸ è¿åŠ¨å‚æ•°è®¾ç½®</h3>
            <button class="btn" onclick="toggleSettings()" style="padding:5px 15px; font-size:12px">å…³é—­</button>
        </div>

        <!-- å…³é”®è®¾ç½®ï¼šæ¯æ­¥åŠ¨åŠ› -->
        <div class="control-row">
            <label>
                <span>âš¡ æ¯æ­¥åŠ¨åŠ› (Step Gain)</span>
                <span id="val-gain" style="color:#00e676">0.5</span>
            </label>
            <input type="range" id="inp-gain" min="0.1" max="2.0" step="0.1" value="0.5" oninput="updateConfig('gain', this.value)">
            <div style="font-size:10px; color:#666; margin-top:5px;">å€¼è¶Šå¤§ï¼Œèµ°ä¸€æ­¥è§†é¢‘åŠ é€Ÿè¶Šå¿«ã€‚</div>
        </div>

        <!-- å…³é”®è®¾ç½®ï¼šçµæ•åº¦ -->
        <div class="control-row">
            <label>
                <span>ğŸ“¡ ä¼ æ„Ÿå™¨çµæ•åº¦ (é˜ˆå€¼)</span>
                <span id="val-sens">3.0</span>
            </label>
            <input type="range" id="inp-sens" min="1.0" max="8.0" step="0.5" value="3.0" oninput="updateConfig('sens', this.value)">
            <div style="font-size:10px; color:#666; margin-top:5px;">å€¼è¶Šå°è¶Šçµæ•ã€‚å¦‚æœä¸åŠ¨ä¹Ÿèµ°ï¼Œè¯·è°ƒå¤§ã€‚</div>
        </div>

        <!-- åŸè§†é¢‘é€Ÿåº¦ -->
        <div class="control-row">
            <label>
                <span>ğŸ¥ åŸè§†é¢‘é€Ÿåº¦ (km/h)</span>
                <span id="val-base">5</span>
            </label>
            <input type="range" id="inp-base" min="3" max="20" step="1" value="5" oninput="updateConfig('base', this.value)">
        </div>

        <div style="border-top:1px solid #333; padding-top:10px; margin-top:10px;">
            <p style="font-size:12px; color:#888; margin-bottom:5px;">è°ƒè¯•å·¥å…·ï¼š</p>
            <button class="btn" onclick="forcePlay()">å¼ºåˆ¶æ’­æ”¾(æµ‹è¯•)</button>
            <button class="btn" onclick="testStep()">æ¨¡æ‹Ÿä¸€æ­¥</button>
            <div id="debug-log" style="font-size:10px; color:#555; margin-top:5px; font-family:monospace;">Logs...</div>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒå˜é‡ ---
        const video = document.getElementById('mainVideo');
        const uiLayer = document.getElementById('ui-layer');
        const startScreen = document.getElementById('start-screen');
        const sensorDot = document.getElementById('sensor-dot');
        const debugLog = document.getElementById('debug-log');
        
        // ç‰©ç†å¼•æ“å˜é‡
        let currentEnergy = 0; // å½“å‰â€œèƒ½é‡â€ï¼ˆå¯¹åº”æ’­æ”¾é€Ÿåº¦ï¼‰
        let stepCount = 0;
        let lastStepTime = 0;
        
        // VRå˜é‡
        let initialAlpha = null;
        let isLandscape = true;

        // é…ç½® (é»˜è®¤å€¼)
        const config = {
            gain: 0.5,      // æ¯æ­¥å¢åŠ å¤šå°‘é€Ÿåº¦ (0.1 - 2.0)
            friction: 0.98, // æ¯ä¸€å¸§èƒ½é‡è¡°å‡ç³»æ•° (0.90 - 0.99)
            sensitivity: 3.0, // è§¦å‘é˜ˆå€¼
            baseSpeed: 5    // è§†é¢‘åŸºå‡†é€Ÿåº¦
        };

        // --- 1. åˆå§‹åŒ–ä¸æ–‡ä»¶ ---
        function handleFile(input) {
            const file = input.files[0];
            if(file) {
                video.src = URL.createObjectURL(file);
                document.getElementById('file-status').innerText = "å·²åŠ è½½: " + file.name;
                const goBtn = document.getElementById('go-btn');
                goBtn.disabled = false;
                goBtn.style.opacity = 1;

                // ç®€å•çš„VRåˆ¤æ–­
                video.onloadedmetadata = () => {
                    isLandscape = video.videoWidth > video.videoHeight;
                    if(isLandscape) {
                        video.style.height = "100vh";
                        video.style.width = "auto"; // å…è®¸æº¢å‡º
                    } else {
                        video.style.width = "100%";
                        video.style.height = "100%";
                    }
                };
            }
        }

        function startGame() {
            // è¯·æ±‚å…¨å±
            if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
            
            startScreen.style.display = 'none';
            uiLayer.style.display = 'flex';

            // å…³é”®ï¼šå…ˆæ’­æ”¾ä¸€ä¸‹ï¼Œç¡®ä¿å¼•æ“æ¿€æ´»ï¼Œç„¶åæš‚åœ
            video.play().then(() => {
                video.pause(); 
                log("Video initialized.");
            }).catch(e => log("Init Err: " + e.message));

            initSensors();
            requestAnimationFrame(gameLoop);
        }

        // --- 2. ä¼ æ„Ÿå™¨é€»è¾‘ ---
        function initSensors() {
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission().then(res => {
                    if (res === 'granted') bindEvents();
                    else alert("éœ€è¦ä¼ æ„Ÿå™¨æƒé™æ‰èƒ½è¿è¡Œ");
                });
            } else {
                bindEvents();
            }
        }

        function bindEvents() {
            window.addEventListener('devicemotion', (e) => {
                // è®¡ç®—åŠ é€Ÿåº¦å˜åŒ–
                let acc = e.accelerationIncludingGravity || e.acceleration;
                if (!acc) return;

                // ç®€å•çš„å»é‡åŠ›ç®—æ³•ï¼šè®¡ç®—æ€»å‘é‡é•¿åº¦ï¼Œå‡å»é‡åŠ›(çº¦9.8)
                let total = Math.sqrt(acc.x*acc.x + acc.y*acc.y + acc.z*acc.z);
                let delta = Math.abs(total - 9.8);

                // è§¦å‘åˆ¤æ–­
                if (delta > config.sensitivity) {
                    onStepDetected();
                }
            });

            window.addEventListener('deviceorientation', (e) => {
                if(!isLandscape || !e.alpha) return;
                if(initialAlpha === null) initialAlpha = e.alpha;
                
                let diff = e.alpha - initialAlpha;
                if(diff > 180) diff -= 360;
                if(diff < -180) diff += 360;
                
                // VR å¹³ç§»æ•ˆæœ
                video.style.transform = `translateX(${-diff * 0.5}%) scale(1.05)`;
            });
        }

        // --- 3. æ ¸å¿ƒï¼šåŠ¨åŠ›å¼•æ“ ---
        function onStepDetected() {
            const now = Date.now();
            if (now - lastStepTime > 300) { // é˜²æŠ–åŠ¨ï¼š300æ¯«ç§’å†…åªèƒ½è§¦å‘ä¸€æ¬¡
                lastStepTime = now;
                stepCount++;
                
                // è§†è§‰åé¦ˆ
                sensorDot.classList.add('sensor-active');
                setTimeout(() => sensorDot.classList.remove('sensor-active'), 100);
                document.getElementById('disp-steps').innerText = stepCount;

                // --- å¢åŠ èƒ½é‡ ---
                // è¿™å°±æ˜¯ä½ è¦çš„â€œæ¯æ­¥é€Ÿåº¦â€é€»è¾‘
                // æ¯æ¬¡è§¦å‘ï¼Œç›´æ¥å¾€ currentEnergy é‡ŒåŠ æ•°
                // è®¾ç½®ä¸Šé™ï¼Œé˜²æ­¢åŠ åˆ°10å€é€Ÿå¤ªç¦»è°±
                currentEnergy += parseFloat(config.gain); 
                if(currentEnergy > 4.0) currentEnergy = 4.0;
                
                log("Step! Energy: " + currentEnergy.toFixed(2));
            }
        }

        // --- 4. æ¸¸æˆå¾ªç¯ (æ¯ä¸€å¸§éƒ½è¿è¡Œ) ---
        function gameLoop() {
            // èƒ½é‡è‡ªç„¶è¡°å‡ (æ‘©æ“¦åŠ›)
            currentEnergy *= config.friction;

            // é˜ˆå€¼å¤„ç†ï¼šå¦‚æœèƒ½é‡å¤ªå°ï¼Œç›´æ¥å½’é›¶ï¼Œé˜²æ­¢æ— é™æ¥è¿‘0ä½†ä¸åœæ­¢
            if (currentEnergy < 0.1) {
                currentEnergy = 0;
            }

            // æ›´æ–° UI
            document.getElementById('disp-rate').innerText = currentEnergy.toFixed(1);
            let realSpeed = currentEnergy * config.baseSpeed;
            document.getElementById('disp-kmh').innerText = realSpeed.toFixed(1) + " km/h";

            // --- è§†é¢‘æ’­æ”¾æ§åˆ¶ (å…³é”®ä¿®æ­£) ---
            if (currentEnergy > 0) {
                // åº”è¯¥æ’­æ”¾
                video.playbackRate = currentEnergy;
                if (video.paused) {
                    let p = video.play();
                    if(p) p.catch(e => { /* å¿½ç•¥é¢‘ç¹åˆ‡æ¢å¯¼è‡´çš„é”™è¯¯ */ });
                    document.getElementById('status-text').innerText = "è¡Œè¿›ä¸­";
                    document.getElementById('status-text').style.color = "#00e676";
                }
            } else {
                // åº”è¯¥æš‚åœ
                if (!video.paused) {
                    video.pause();
                    document.getElementById('status-text').innerText = "å·²åœæ­¢";
                    document.getElementById('status-text').style.color = "#888";
                }
            }

            // è¿›åº¦æ¡
            if(video.duration) {
                const pct = (video.currentTime / video.duration) * 100;
                document.getElementById('progress-bar').style.width = pct + "%";
            }

            requestAnimationFrame(gameLoop);
        }

        // --- 5. è®¾ç½®ä¸è°ƒè¯•å·¥å…· ---
        function toggleSettings() {
            const panel = document.getElementById('settings-panel');
            panel.classList.toggle('show');
        }

        function updateConfig(key, val) {
            // æ›´æ–°é…ç½®å¹¶æ˜¾ç¤ºæ•°å€¼
            val = parseFloat(val);
            config[key] = val;
            
            // æ›´æ–°æ˜¾ç¤ºçš„æ•°å­—
            if(key === 'gain') document.getElementById('val-gain').innerText = val.toFixed(1);
            if(key === 'sens') document.getElementById('val-sens').innerText = val.toFixed(1);
            if(key === 'base') document.getElementById('val-base').innerText = val;
        }

        function log(msg) {
            debugLog.innerText = msg;
            console.log(msg);
        }

        // è°ƒè¯•ç”¨ï¼šå¼ºåˆ¶æ¨¡æ‹Ÿ
        function testStep() {
            onStepDetected();
        }
        function forcePlay() {
            video.play();
            video.playbackRate = 1.0;
            currentEnergy = 1.0;
        }

    </script>
</body>
</html>
