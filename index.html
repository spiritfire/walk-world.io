<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¼«æ­¥ V5 - é€æ˜æé€Ÿç‰ˆ</title>
    <style>
        /* --- å…¨å±€ --- */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: #000; overflow: hidden;
            font-family: sans-serif; -webkit-user-select: none; user-select: none;
        }

        /* è§†é¢‘å±‚ */
        #video-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }
        video {
            width: 100%; height: 100%; object-fit: cover;
            /* å…³é”®ï¼šç§»é™¤ç¼©æ”¾ï¼Œåªä¿ç•™ä½ç§»è¿‡æ¸¡ */
            transition: transform 0.1s linear; 
        }

        /* UI å±‚ (å®Œå…¨é€æ˜) */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€ */
            display: flex; flex-direction: column; justify-content: space-between;
        }

        /* é¡¶éƒ¨æ•°æ® (æ— èƒŒæ™¯ï¼Œé‡é˜´å½±) */
        .top-stats {
            padding: 20px;
            display: flex; justify-content: space-between;
            /* ç§»é™¤èƒŒæ™¯è‰² */
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.9); /* å¼ºé˜´å½±é˜²çœ‹ä¸æ¸… */
        }
        
        .stat-group { display: flex; flex-direction: column; }
        .stat-left { text-align: left; }
        .stat-right { text-align: right; }
        
        .big-text { font-size: 42px; font-weight: 800; line-height: 1; }
        .unit-text { font-size: 14px; opacity: 0.9; font-weight: bold; }
        .sub-text { font-size: 14px; margin-top: 5px; color: #4CAF50; font-weight: bold; text-shadow: 1px 1px 2px black;}

        /* åº•éƒ¨æ§åˆ¶ (æ— èƒŒæ™¯) */
        .bottom-controls {
            padding: 20px;
            pointer-events: auto; /* å…è®¸ç‚¹å‡»è®¾ç½®æŒ‰é’® */
            display: flex; flex-direction: column; gap: 10px;
        }

        /* è¿›åº¦æ¡ */
        .prog-container {
            width: 100%; height: 8px; background: rgba(255,255,255,0.3);
            border-radius: 4px; overflow: hidden; backdrop-filter: blur(2px);
        }
        .prog-bar {
            height: 100%; width: 0%; background: #4CAF50;
            box-shadow: 0 0 10px black;
        }
        .time-display {
            text-align: right; font-size: 12px; margin-bottom: 5px; 
            color: white; text-shadow: 1px 1px 2px black;
        }

        /* è®¾ç½®æŒ‰é’® */
        .btn-settings {
            align-self: flex-end; /* é å³ */
            background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.3);
            color: white; padding: 8px 15px; border-radius: 20px;
            font-size: 12px; backdrop-filter: blur(4px);
        }

        /* è®¾ç½®é¢æ¿ (æŠ½å±‰) */
        #settings-panel {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(20, 20, 20, 0.95); /* æ·±è‰²èƒŒæ™¯ */
            border-top: 1px solid #444; border-radius: 20px 20px 0 0;
            padding: 20px; box-sizing: border-box;
            transform: translateY(110%); transition: transform 0.3s ease;
            z-index: 20; pointer-events: auto; color: white;
        }
        #settings-panel.open { transform: translateY(0); }

        .setting-item { margin-bottom: 20px; }
        .setting-label { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; color: #ccc; }
        .setting-val { color: #4CAF50; font-weight: bold; }
        
        input[type=range] { width: 100%; }

        /* å¯åŠ¨é¡µ */
        #start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 99; display: flex; flex-direction: column;
            align-items: center; justify-content: center; text-align: center;
        }
        .btn-big {
            padding: 15px 40px; border-radius: 50px; border: none; font-size: 18px; font-weight: bold; margin: 10px; cursor: pointer;
        }
    </style>
</head>
<body>

    <!-- å¯åŠ¨é¡µ -->
    <div id="start-overlay">
        <h1 style="color:#4CAF50;">ğŸƒ æ¼«æ­¥è€… V5</h1>
        <p style="color:#888; margin-bottom:30px;">é€æ˜UI Â· æé€Ÿå“åº” Â· ç‰©ç†æ­¥é€Ÿ</p>
        
        <button class="btn-big" style="background:#2196F3; color:white;" onclick="document.getElementById('fileIn').click()">ğŸ“‚ é€‰æ‹©è§†é¢‘</button>
        <input type="file" id="fileIn" accept="video/*" style="display:none" onchange="loadFile(this)">
        
        <div id="file-status" style="color:#4CAF50; height:20px; font-size:12px; margin-bottom:20px;"></div>
        
        <button id="btn-start" class="btn-big" style="background:#4CAF50; color:white; opacity:0.5;" onclick="startApp()" disabled>ğŸš€ å…¨å±å¼€å§‹</button>
    </div>

    <!-- è§†é¢‘ -->
    <div id="video-layer">
        <video id="vid" playsinline loop muted webkit-playsinline></video>
    </div>

    <!-- é€æ˜ UI -->
    <div id="ui-layer" style="display:none;">
        <div class="top-stats">
            <div class="stat-group stat-left">
                <div class="big-text" id="disp-speed">0.0</div>
                <div class="unit-text">å½“å‰æ—¶é€Ÿ (km/h)</div>
                <div class="sub-text" id="disp-rate">å€ç‡: 0.0x</div>
            </div>
            <div class="stat-group stat-right">
                <div class="big-text" id="disp-steps">0</div>
                <div class="unit-text">æ­¥æ•°</div>
                <div class="sub-text" id="disp-dist">0.00 km</div>
            </div>
        </div>

        <div class="bottom-controls">
            <div class="time-display"><span id="t-curr">0:00</span> / <span id="t-total">0:00</span></div>
            <div class="prog-container">
                <div class="prog-bar" id="prog-bar"></div>
            </div>
            <button class="btn-settings" onclick="toggleSet()">âš™ï¸ è®¾ç½®</button>
        </div>
    </div>

    <!-- è®¾ç½®é¢æ¿ -->
    <div id="settings-panel">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <h3>å‚æ•°è®¾ç½®</h3>
            <button onclick="toggleSet()" style="background:none; border:none; color:#888; font-size:24px;">Ã—</button>
        </div>

        <div class="setting-item">
            <div class="setting-label"><span>åŸè§†é¢‘é€Ÿåº¦</span><span class="setting-val" id="val-base">5 km/h</span></div>
            <input type="range" min="2" max="20" value="5" oninput="updateCfg('base', this.value)">
        </div>
        
        <div class="setting-item">
            <div class="setting-label"><span>æˆ‘çš„æ­¥é•¿</span><span class="setting-val" id="val-stride">0.7 m</span></div>
            <input type="range" min="0.4" max="1.2" step="0.05" value="0.7" oninput="updateCfg('stride', this.value)">
        </div>

        <div class="setting-item">
            <div class="setting-label"><span>ä¼ æ„Ÿå™¨çµæ•åº¦ (è¶Šå°è¶Šçµæ•)</span><span class="setting-val" id="val-sens">1.5</span></div>
            <input type="range" min="0.5" max="5.0" step="0.1" value="1.5" oninput="updateCfg('sens', this.value)">
        </div>

        <div style="margin-top:20px; font-size:12px; color:#666;">
            * ä¿®æ­£è¯´æ˜ï¼šå·²ç§»é™¤ç”»é¢ç¼©æ”¾ï¼Œå·²ä¿®å¤æš‚åœåé‡æ–°èµ°è·¯å¡é¡¿çš„é—®é¢˜ã€‚
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒçŠ¶æ€ ---
        const cfg = {
            baseSpeed: 5,
            stride: 0.7,
            sens: 1.5,
            vrLimit: 25 // VRæœ€å¤§åç§»è§’åº¦
        };
        
        let state = {
            running: false,
            steps: 0,
            lastStepT: 0,
            currRate: 0,
            targetRate: 0,
            isLandscape: false,
            initAlpha: null
        };

        const vid = document.getElementById('vid');
        let audioCtx;

        // --- 1. å¯åŠ¨é€»è¾‘ ---
        function loadFile(el) {
            const f = el.files[0];
            if(!f) return;
            vid.src = URL.createObjectURL(f);
            document.getElementById('file-status').innerText = f.name;
            document.getElementById('btn-start').disabled = false;
            document.getElementById('btn-start').style.opacity = 1;
            
            vid.onloadedmetadata = () => {
                state.isLandscape = vid.videoWidth > vid.videoHeight;
                if(state.isLandscape) {
                    // VRæ¨¡å¼ï¼šé«˜åº¦æ’‘æ»¡ï¼Œå®½åº¦è‡ªé€‚åº”(æº¢å‡º)
                    vid.style.width = 'auto';
                    vid.style.height = '100vh';
                } else {
                    vid.style.width = '100%';
                    vid.style.height = '100%';
                }
            };
        }

        function startApp() {
            if(document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
            document.getElementById('start-overlay').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'flex';
            
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            // æƒé™ä¸å¯åŠ¨
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission().then(r => {
                    if(r==='granted') initSensors();
                });
            } else {
                initSensors();
            }

            vid.play().then(() => vid.pause()); // é¢„çƒ­
            state.running = true;
            requestAnimationFrame(loop);
        }

        function initSensors() {
            window.addEventListener('devicemotion', onMotion);
            window.addEventListener('deviceorientation', onOrient);
        }

        // --- 2. è¿åŠ¨å¼•æ“ (å·²ä¿®å¤å†·å¯åŠ¨å¡é¡¿) ---
        function onMotion(e) {
            const acc = e.accelerationIncludingGravity || e.acceleration;
            if(!acc) return;
            
            const val = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
            const delta = Math.abs(val - 9.8);

            if(delta > cfg.sens) {
                stepTrigger();
            }
        }

        function stepTrigger() {
            const now = Date.now();
            const diff = now - state.lastStepT;

            if(diff < 250) return; // é˜²æŠ–

            state.steps++;
            feedback(); // éœ‡åŠ¨+å£°éŸ³

            // --- å…³é”®ä¿®å¤ï¼šå†·å¯åŠ¨é€»è¾‘ ---
            // å¦‚æœåœé¡¿è¶…è¿‡2ç§’ (2000ms)ï¼Œè§†ä¸ºé‡æ–°èµ·æ­¥
            if(diff > 2000) {
                // ä¸è®¡ç®—å…·ä½“é€Ÿåº¦ï¼Œç›´æ¥ç»™äºˆä¸€ä¸ªâ€œå¯åŠ¨æ¨åŠ›â€
                // å‡è®¾ä»¥ 4km/h å¯åŠ¨
                const startUpSpeed = 4.0; 
                state.targetRate = startUpSpeed / cfg.baseSpeed;
                
                // å¼ºåˆ¶å°†å½“å‰é€Ÿç‡ä¹Ÿæä¸Šæ¥ï¼Œé¿å…Lerpæ…¢æ…¢çˆ¬
                state.currRate = state.targetRate; 
            } else {
                // æ­£å¸¸è¿ç»­è¡Œèµ°ï¼šè®¡ç®—çœŸå®ç‰©ç†é€Ÿåº¦
                // æ­¥é¢‘ (steps/sec) = 1000 / diff
                const cadence = 1000 / diff;
                const speedKmh = cadence * cfg.stride * 3.6;
                state.targetRate = speedKmh / cfg.baseSpeed;
            }

            state.lastStepT = now;
        }

        // åé¦ˆ
        function feedback() {
            if(navigator.vibrate) navigator.vibrate(15);
            if(audioCtx && audioCtx.state === 'running') {
                const o = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                o.connect(g); g.connect(audioCtx.destination);
                o.frequency.setValueAtTime(120, audioCtx.currentTime);
                o.frequency.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.1);
                g.gain.setValueAtTime(0.2, audioCtx.currentTime);
                g.gain.linearRampToValueAtTime(0, audioCtx.currentTime+0.1);
                o.start(); o.stop(audioCtx.currentTime+0.1);
            }
        }

        // VR (å·²ä¿®å¤ç¼©æ”¾å’Œæ–¹å‘)
        function onOrient(e) {
            if(!state.isLandscape || !e.alpha) return;
            if(state.initAlpha === null) state.initAlpha = e.alpha;

            let d = e.alpha - state.initAlpha;
            if(d > 180) d -= 360;
            if(d < -180) d += 360;

            // é™åˆ¶æœ€å¤§è§’åº¦ï¼Œé˜²æ­¢é»‘è¾¹
            d = Math.max(-cfg.vrLimit, Math.min(cfg.vrLimit, d));

            // æ–¹å‘ä¿®æ­£ï¼šå·¦è½¬å¤´(dè´Ÿ) -> ç”»é¢å‘å³ç§»(translateæ­£)
            // æ¯”ä¾‹ï¼š25åº¦ å¯¹åº” 15% ä½ç§» (å› ä¸ºæ²¡æœ‰scaleï¼Œä½ç§»å¤ªå¤§ä¹Ÿä¼šéœ²é¦…)
            const pct = -(d / cfg.vrLimit) * 15;
            
            // åªæœ‰ translateXï¼Œæ²¡æœ‰ scale
            vid.style.transform = `translateX(${pct}%)`;
        }

        // --- 3. å¾ªç¯ ---
        function loop() {
            if(!state.running) return;

            // è‡ªåŠ¨åœè½¦æ£€æµ‹
            if(Date.now() - state.lastStepT > 1500) {
                state.targetRate = 0;
            }

            // å¹³æ»‘è¿‡æ¸¡
            const err = state.targetRate - state.currRate;
            if(Math.abs(err) > 0.01) {
                state.currRate += err * 0.1; // 0.1ç³»æ•°è®©ååº”å˜å¿«
            } else {
                state.currRate = state.targetRate;
            }

            // åº”ç”¨æ’­æ”¾
            if(state.currRate > 0.05) {
                vid.playbackRate = state.currRate;
                if(vid.paused) vid.play().catch(e=>{});
            } else {
                if(!vid.paused) vid.pause();
                state.currRate = 0;
            }

            updateUI();
            requestAnimationFrame(loop);
        }

        function updateUI() {
            // æ—¶é€Ÿ
            const kmh = state.currRate * cfg.baseSpeed;
            document.getElementById('disp-speed').innerText = kmh.toFixed(1);
            document.getElementById('disp-rate').innerText = "å€ç‡: " + state.currRate.toFixed(2) + "x";

            // æ­¥æ•°ä¸è·ç¦»
            document.getElementById('disp-steps').innerText = state.steps;
            const dist = (state.steps * cfg.stride) / 1000;
            document.getElementById('disp-dist').innerText = dist.toFixed(2) + " km";

            // è¿›åº¦
            if(vid.duration) {
                const p = (vid.currentTime / vid.duration) * 100;
                document.getElementById('prog-bar').style.width = p + "%";
                document.getElementById('t-curr').innerText = fmt(vid.currentTime);
                document.getElementById('t-total').innerText = fmt(vid.duration);
            }
        }

        // --- è¾…åŠ© ---
        function toggleSet() {
            document.getElementById('settings-panel').classList.toggle('open');
        }
        function updateCfg(k, v) {
            v = parseFloat(v);
            if(k==='base') { cfg.baseSpeed = v; document.getElementById('val-base').innerText = v+" km/h"; }
            if(k==='stride') { cfg.stride = v; document.getElementById('val-stride').innerText = v+" m"; }
            if(k==='sens') { cfg.sens = v; document.getElementById('val-sens').innerText = v; }
        }
        function fmt(s) {
            const m = Math.floor(s/60);
            const sc = Math.floor(s%60);
            return `${m}:${sc<10?'0'+sc:sc}`;
        }

    </script>
</body>
</html>
