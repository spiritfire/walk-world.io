<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¼«æ­¥ V7 - æœ€ç»ˆé‡æ„ç‰ˆ</title>
    <style>
        /* --- å…¨å±€ --- */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: #000; overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            color: white; user-select: none;
        }

        /* è§†é¢‘å±‚ï¼šæ— ç¼©æ”¾ï¼Œä»…ä½ç§» */
        #video-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }
        video {
            width: 100%; height: 100%; object-fit: cover;
            transition: transform 0.1s linear; /* ä»…ç”¨äºVRä½ç§» */
        }

        /* UI å±‚ï¼šå…¨é€æ˜ */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
            text-shadow: 0 2px 5px rgba(0,0,0,0.9); /* å¼ºé˜´å½±ä¿è¯å¯è§æ€§ */
        }

        /* é¡¶éƒ¨æ•°æ® */
        .top-bar {
            padding: 25px; display: flex; justify-content: space-between;
        }
        .data-group { display: flex; flex-direction: column; }
        .align-right { text-align: right; }
        
        .val-big { font-size: 56px; font-weight: 800; line-height: 0.9; font-variant-numeric: tabular-nums; }
        .val-unit { font-size: 14px; font-weight: bold; color: #ccc; margin-top: 5px; }
        .val-sub { font-size: 16px; color: #00e676; font-weight: bold; margin-top: 5px; }

        /* åº•éƒ¨æ§åˆ¶ */
        .btm-bar {
            padding: 25px; pointer-events: auto;
            display: flex; flex-direction: column; gap: 10px;
        }

        .progress-box {
            width: 100%; height: 8px; background: rgba(255,255,255,0.2);
            border-radius: 4px; overflow: hidden; backdrop-filter: blur(4px);
        }
        .progress-bar {
            height: 100%; width: 0%; background: #00e676;
            box-shadow: 0 0 10px #00e676; transition: width 0.2s linear;
        }
        .time-txt { text-align: right; font-size: 12px; margin-bottom: 5px; opacity: 0.8; }

        /* è®¾ç½®é¢æ¿ */
        #settings {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(15, 15, 15, 0.98);
            border-top: 1px solid #333; border-radius: 20px 20px 0 0;
            padding: 25px; box-sizing: border-box;
            transform: translateY(110%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 20; pointer-events: auto; color: white;
        }
        #settings.open { transform: translateY(0); }

        .row { margin-bottom: 25px; }
        .row-head { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; color: #aaa; }
        .row-val { color: #00e676; font-weight: bold; }
        input[type=range] { width: 100%; height: 4px; background: #444; -webkit-appearance: none; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 24px; height: 24px; background: white; border-radius: 50%; box-shadow: 0 2px 6px black; margin-top: -10px; } /* ä¿®æ­£æ»‘å—å±…ä¸­ */
        input[type=range]::-webkit-slider-runnable-track { height: 4px; background: #444; border-radius: 2px; }

        /* å¯åŠ¨é¡µ */
        #starter {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .btn {
            background: #222; border: 1px solid #444; color: white;
            padding: 15px 40px; border-radius: 50px; font-size: 16px; font-weight: bold;
            margin: 10px; cursor: pointer; transition: 0.2s;
        }
        .btn-green { background: #00e676; color: black; border: none; }
        .btn-set { background: transparent; border: 1px solid rgba(255,255,255,0.3); padding: 8px 20px; font-size: 12px; align-self: flex-end; backdrop-filter: blur(5px); }

    </style>
</head>
<body>

    <!-- å¯åŠ¨é¡µ -->
    <div id="starter">
        <h1 style="color:#00e676; margin-bottom:10px;">ğŸƒ æ¼«æ­¥ V7</h1>
        <p style="color:#666; font-size:12px; margin-bottom:40px;">å†…æ ¸é‡å†™ Â· é›¶å»¶è¿Ÿèµ·æ­¥ Â· VRä¿®æ­£</p>
        
        <button class="btn" onclick="document.getElementById('f-in').click()">1. é€‰æ‹©è§†é¢‘</button>
        <input type="file" id="f-in" accept="video/*" style="display:none" onchange="loadFile(this)">
        <div id="f-name" style="color:#00e676; font-size:12px; height:20px; margin-bottom:20px;"></div>
        
        <button id="btn-go" class="btn btn-green" onclick="launch()" disabled style="opacity:0.3">2. å¼€å§‹è¿åŠ¨</button>
    </div>

    <!-- è§†é¢‘ -->
    <div id="video-layer">
        <video id="vid" playsinline loop muted webkit-playsinline></video>
    </div>

    <!-- HUD -->
    <div id="ui-layer" style="display:none;">
        <div class="top-bar">
            <div class="data-group">
                <div class="val-big" id="dsp-speed">0.0</div>
                <div class="val-unit">å½“å‰æ—¶é€Ÿ (km/h)</div>
                <div class="val-sub" id="dsp-rate">0.0 x</div>
            </div>
            <div class="data-group align-right">
                <div class="val-big" id="dsp-steps">0</div>
                <div class="val-unit">æ­¥æ•°</div>
                <div class="val-sub" id="dsp-dist">0.00 km</div>
            </div>
        </div>

        <div class="btm-bar">
            <div class="time-txt"><span id="t-now">0:00</span> / <span id="t-end">0:00</span></div>
            <div class="progress-box">
                <div class="progress-bar" id="p-bar"></div>
            </div>
            <button class="btn btn-set" onclick="toggleSet()">âš™ï¸ è®¾ç½®</button>
        </div>
    </div>

    <!-- è®¾ç½® -->
    <div id="settings">
        <div style="display:flex; justify-content:space-between; margin-bottom:30px;">
            <h3>è¿åŠ¨å‚æ•°</h3>
            <button onclick="toggleSet()" style="background:none; border:none; color:#666; font-size:24px;">Ã—</button>
        </div>

        <div class="row">
            <div class="row-head"><span>åŸè§†é¢‘å½•åˆ¶é€Ÿåº¦</span><span class="row-val" id="val-base">5 km/h</span></div>
            <input type="range" min="2" max="20" value="5" oninput="updCfg('base',this.value)">
        </div>

        <div class="row">
            <div class="row-head"><span>æˆ‘çš„æ­¥é•¿</span><span class="row-val" id="val-stride">0.70 m</span></div>
            <input type="range" min="0.4" max="1.2" step="0.05" value="0.7" oninput="updCfg('stride',this.value)">
        </div>

        <div class="row">
            <div class="row-head"><span>ä¼ æ„Ÿå™¨çµæ•åº¦ (1=æœ€çµæ•)</span><span class="row-val" id="val-sens">1.5</span></div>
            <input type="range" min="0.5" max="5.0" step="0.1" value="1.5" oninput="updCfg('sens',this.value)">
        </div>

        <div style="text-align:center; padding-top:10px; border-top:1px solid #333;">
            <button class="btn" style="font-size:12px; padding:10px 20px;" onclick="simStep()">ğŸ§ª æ¨¡æ‹Ÿèµ°ä¸€æ­¥</button>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒé…ç½® ---
        const cfg = {
            base: 5,       // åŸè§†é¢‘é€Ÿåº¦ (km/h)
            stride: 0.7,   // æ­¥é•¿ (m)
            sens: 1.5,     // çµæ•åº¦é˜ˆå€¼
            vrLimit: 25    // VRåè½¬æœ€å¤§è§’åº¦
        };

        const state = {
            active: false,
            steps: 0,
            
            // é€Ÿåº¦å¼•æ“å˜é‡
            lastT: 0,         // ä¸Šä¸€æ­¥çš„æ—¶é—´æˆ³
            history: [],      // æœ€è¿‘3æ­¥çš„æ­¥é¢‘(SPM)ç¼“å­˜
            
            currRate: 0,      // å½“å‰æ’­æ”¾ç‡
            targetRate: 0,    // ç›®æ ‡æ’­æ”¾ç‡
            
            isLandscape: false,
            initAlpha: null
        };

        const vid = document.getElementById('vid');
        let audioCtx;

        // --- 1. å¯åŠ¨é€»è¾‘ ---
        function loadFile(el) {
            const f = el.files[0];
            if(!f) return;
            vid.src = URL.createObjectURL(f);
            document.getElementById('f-name').innerText = f.name;
            document.getElementById('btn-go').disabled = false;
            document.getElementById('btn-go').style.opacity = 1;
            
            vid.onloadedmetadata = () => {
                state.isLandscape = vid.videoWidth > vid.videoHeight;
                if(state.isLandscape) {
                    vid.style.width = 'auto'; vid.style.height = '100vh';
                } else {
                    vid.style.width = '100%'; vid.style.height = '100%';
                }
            };
        }

        function launch() {
            if(document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
            document.getElementById('starter').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'flex';
            
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();

            // ä¼ æ„Ÿå™¨æƒé™
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission().then(r => { if(r==='granted') initSensors(); });
            } else {
                initSensors();
            }

            vid.play().then(() => vid.pause()).catch(()=>{});
            state.active = true;
            requestAnimationFrame(loop);
        }

        function initSensors() {
            window.addEventListener('devicemotion', onMotion);
            window.addEventListener('deviceorientation', onOrient);
        }

        // --- 2. è¿åŠ¨å¼•æ“ (é‡å†™ç‰ˆ) ---
        function onMotion(e) {
            const acc = e.accelerationIncludingGravity || e.acceleration;
            if(!acc) return;
            const val = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
            // ç®€å•é«˜é€šæ»¤æ³¢
            if (Math.abs(val - 9.8) > cfg.sens) {
                processStep();
            }
        }

        function processStep() {
            const now = Date.now();
            const timeDiff = now - state.lastT;

            // é˜²æŠ–ï¼š250ms (é™åˆ¶æœ€é«˜æ­¥é¢‘ 240)
            if (timeDiff < 250) return;

            // åé¦ˆ
            feedback();
            state.steps++;

            // === æ ¸å¿ƒä¿®å¤é€»è¾‘ ===
            // å¦‚æœä¸¤æ­¥é—´éš”è¶…è¿‡ 2ç§’ï¼Œè§†ä¸ºâ€œæ–­æ¡£â€æˆ–â€œé‡æ–°èµ·æ­¥â€
            // æˆ–è€…æ˜¯ç¬¬ä¸€æ¬¡èµ°
            if (timeDiff > 2000) {
                // 1. è¿™æ˜¯ä¸€ä¸ªå…¨æ–°çš„å¼€å§‹ï¼Œä¸è¦ç”¨ timeDiff è®¡ç®—é€Ÿåº¦ï¼Œå› ä¸º timeDiff å¯èƒ½æ˜¯ 10ç§’ã€1åˆ†é’Ÿ
                // 2. å¼ºåˆ¶æ¸…ç©ºå†å²ç¼“å†²ï¼Œé˜²æ­¢æ—§æ•°æ®æ‹–æ…¢æ–°é€Ÿåº¦
                state.history = [];
                
                // 3. å¼ºåˆ¶èµ‹äºˆä¸€ä¸ªâ€œå¯åŠ¨æ­¥é¢‘â€ (å‡è®¾æ¯åˆ†é’Ÿ80æ­¥çš„æ…¢è·‘èŠ‚å¥)
                // è¿™æ ·è§†é¢‘ä¼šç«‹åˆ»åŠ¨èµ·æ¥ï¼Œä¸ä¼šå¡åœ¨ 0.xx
                const startSPM = 80; 
                pushHistory(startSPM);
                
                // 4. é‡ç½® lastT
                state.lastT = now;
                
            } else {
                // è¿ç»­è¡Œèµ°ï¼šè®¡ç®—çœŸå®çš„ç¬æ—¶æ­¥é¢‘
                // SPM = 60000 / ms
                const currentSPM = 60000 / timeDiff;
                pushHistory(currentSPM);
                
                state.lastT = now;
            }

            calcTargetRate();
        }

        function pushHistory(spm) {
            state.history.push(spm);
            // åªä¿ç•™æœ€è¿‘ 3 æ¬¡æ•°æ®åšå¹³æ»‘
            if (state.history.length > 3) state.history.shift();
        }

        function calcTargetRate() {
            // å–å¹³å‡æ­¥é¢‘ (SPM)
            let sum = 0;
            state.history.forEach(v => sum += v);
            const avgSPM = sum / state.history.length;

            // ç‰©ç†å…¬å¼è½¬æ¢ï¼š
            // é€Ÿåº¦(m/min) = SPM * æ­¥é•¿
            // é€Ÿåº¦(km/h) = é€Ÿåº¦(m/min) * 60 / 1000
            const speedKmh = (avgSPM * cfg.stride * 60) / 1000;

            // è®¡ç®—ç›®æ ‡å€ç‡
            state.targetRate = speedKmh / cfg.base;
        }

        function feedback() {
            if(navigator.vibrate) navigator.vibrate(15);
            if(audioCtx && audioCtx.state === 'running') {
                const o = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                o.connect(g); g.connect(audioCtx.destination);
                o.frequency.setValueAtTime(120, audioCtx.currentTime);
                o.frequency.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.1);
                g.gain.setValueAtTime(0.2, audioCtx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.1);
                o.start(); o.stop(audioCtx.currentTime+0.1);
            }
        }

        // --- 3. VR é€»è¾‘ (å·²ä¿®æ­£æ–¹å‘) ---
        function onOrient(e) {
            if(!state.isLandscape || !e.alpha) return;
            if(state.initAlpha === null) state.initAlpha = e.alpha;

            let d = e.alpha - state.initAlpha;
            if(d > 180) d -= 360;
            if(d < -180) d += 360;

            // é™åˆ¶å¯è§†è§’åº¦
            d = Math.max(-cfg.vrLimit, Math.min(cfg.vrLimit, d));

            // æ–¹å‘ä¿®æ­£ï¼š
            // å·¦è½¬å¤´ (d < 0) -> ç”»é¢åº”è¯¥å‘å³ç§» (Translate > 0) ä»¥æ˜¾ç¤ºå·¦ä¾§å†…å®¹
            // æ‰€ä»¥ç³»æ•°åº”è¯¥æ˜¯ è´Ÿæ•°
            const pct = d * -0.8; // 0.8 æ˜¯ä½ç§»ç³»æ•°
            
            vid.style.transform = `translateX(${pct}%)`;
        }

        // --- 4. ä¸»å¾ªç¯ ---
        function loop() {
            if(!state.active) return;

            // è‡ªåŠ¨åœè½¦æ£€æµ‹
            // å¦‚æœè¶…è¿‡ 2ç§’ æ²¡æœ‰æ–°æ­¥æ•°ï¼Œç›®æ ‡é€Ÿåº¦å½’é›¶
            if (Date.now() - state.lastT > 2000) {
                state.targetRate = 0;
                // æ³¨æ„ï¼šè¿™é‡Œä¸è¦æ¸…ç©º historyï¼Œå› ä¸ºä¸‹ä¸€æ¬¡ processStep ä¼šæ£€æµ‹åˆ° timeout å¹¶è‡ªåŠ¨æ¸…ç©º
            }

            // å¹³æ»‘è¿‡æ¸¡ (Lerp)
            const diff = state.targetRate - state.currRate;
            if (Math.abs(diff) > 0.01) {
                state.currRate += diff * 0.1; // 0.1 å“åº”é€Ÿåº¦é€‚ä¸­
            } else {
                state.currRate = state.targetRate;
            }

            // æ’­æ”¾åº”ç”¨
            if (state.currRate > 0.05) {
                vid.playbackRate = state.currRate;
                if(vid.paused) vid.play().catch(()=>{});
            } else {
                if(!vid.paused) vid.pause();
                state.currRate = 0;
            }

            draw();
            requestAnimationFrame(loop);
        }

        function draw() {
            // é€Ÿåº¦
            const kmh = state.currRate * cfg.base;
            document.getElementById('dsp-speed').innerText = kmh.toFixed(1);
            document.getElementById('dsp-rate').innerText = state.currRate.toFixed(2) + " x";
            
            // æ­¥æ•°é‡Œç¨‹
            document.getElementById('dsp-steps').innerText = state.steps;
            const dist = (state.steps * cfg.stride) / 1000;
            document.getElementById('dsp-dist').innerText = dist.toFixed(2) + " km";

            // è¿›åº¦
            if(vid.duration) {
                const p = (vid.currentTime / vid.duration) * 100;
                document.getElementById('p-bar').style.width = p + "%";
                document.getElementById('t-now').innerText = fmt(vid.currentTime);
                document.getElementById('t-end').innerText = fmt(vid.duration);
            }
        }

        // --- è¾…åŠ© ---
        function toggleSet() { document.getElementById('settings').classList.toggle('open'); }
        function updCfg(k,v) {
            v=parseFloat(v);
            if(k==='base') { cfg.base=v; document.getElementById('val-base').innerText=v+" km/h"; }
            if(k==='stride') { cfg.stride=v; document.getElementById('val-stride').innerText=v.toFixed(2)+" m"; }
            if(k==='sens') { cfg.sens=v; document.getElementById('val-sens').innerText=v; }
        }
        function fmt(s) { const m=Math.floor(s/60), sc=Math.floor(s%60); return `${m}:${sc<10?'0'+sc:sc}`; }
        function simStep() { processStep(); }

    </script>
</body>
</html>
