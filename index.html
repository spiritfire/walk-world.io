<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¥èº«æ¼«æ­¥ - æ²‰æµ¸ç‰ˆ</title>
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            background-color: #000;
            overflow: hidden;
            font-family: sans-serif;
            color: white;
            -webkit-user-select: none; /* ç¦æ­¢é€‰ä¸­æ–‡æœ¬ */
            user-select: none;
        }

        /* è§†é¢‘å®¹å™¨ï¼šç»å¯¹å®šä½ï¼Œé“ºæ»¡ */
        #video-wrapper {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        video {
            /* é»˜è®¤çŠ¶æ€ */
            width: 100%; height: 100%;
            object-fit: cover;
            transition: transform 0.1s ease-out; /* VRå¹³ç§»æ—¶çš„è¿‡æ¸¡ */
        }

        /* --- å¯åŠ¨é®ç½©å±‚ --- */
        #overlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #111;
            z-index: 999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
        }
        
        .btn {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            border: none;
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: bold;
            margin: 10px 0;
            width: 80%;
            max-width: 300px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .btn-blue { background: linear-gradient(135deg, #2196F3, #1565C0); }
        .btn:disabled { opacity: 0.5; filter: grayscale(1); }

        /* --- æ²‰æµ¸å¼ UI (HUD) --- */
        #hud {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 10;
            pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€åˆ°è§†é¢‘ï¼Œé™¤éç‚¹å‡»æŒ‰é’® */
            display: none; /* å¯åŠ¨åæ˜¾ç¤º */
        }

        /* å·¦ä¸Šè§’ï¼šé€Ÿåº¦ä»ªè¡¨ */
        .hud-top-left {
            position: absolute;
            top: 20px; left: 20px;
            background: rgba(0, 0, 0, 0.3); /* åŠé€æ˜ */
            padding: 10px 15px;
            border-radius: 12px;
            backdrop-filter: blur(2px);
            text-shadow: 1px 1px 2px black;
        }
        .speed-val { font-size: 32px; font-weight: 800; color: #fff; }
        .speed-unit { font-size: 12px; color: #ddd; text-transform: uppercase; }

        /* å³ä¸Šè§’ï¼šæ­¥æ•° & ä¼ æ„Ÿå™¨çŠ¶æ€ */
        .hud-top-right {
            position: absolute;
            top: 20px; right: 20px;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 15px;
            border-radius: 12px;
            text-align: right;
        }
        /* ä¼ æ„Ÿå™¨æŒ‡ç¤ºç¯ */
        .sensor-dot {
            display: inline-block;
            width: 10px; height: 10px;
            border-radius: 50%;
            background-color: #555;
            margin-right: 5px;
        }
        .sensor-active { background-color: #0f0; box-shadow: 0 0 5px #0f0; }

        /* åº•éƒ¨ï¼šè¿›åº¦æ¡ */
        .progress-wrapper {
            position: absolute;
            bottom: 0; left: 0;
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.2);
        }
        .progress-fill {
            height: 100%;
            width: 0%;
            background: #4CAF50; /* é²œè‰³çš„ç»¿è‰² */
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.7);
            transition: width 0.5s linear;
        }

        /* åº•éƒ¨æ§åˆ¶æŒ‰é’®åŒº */
        .controls-trigger {
            position: absolute;
            bottom: 20px;
            right: 20px;
            pointer-events: auto;
            background: rgba(0,0,0,0.4);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 14px;
        }

        /* è®¾ç½®é¢æ¿ (Modal) */
        #settings-modal {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 85%;
            background: rgba(20, 20, 20, 0.95);
            border: 1px solid #333;
            border-radius: 15px;
            padding: 20px;
            z-index: 100;
            display: none;
            pointer-events: auto;
            color: #eee;
        }
        
        .setting-row { margin-bottom: 15px; }
        .setting-row label { display: block; margin-bottom: 5px; font-size: 14px; color: #aaa; }
        .setting-row input[type=range] { width: 100%; }
        .setting-row input[type=number] { 
            background: #333; border: 1px solid #555; color: white; 
            padding: 5px; border-radius: 4px; width: 60px;
        }

        .close-btn {
            background: #444; width: 100%; padding: 10px; margin-top: 10px;
        }
        
        /* è°ƒè¯•ä¿¡æ¯ */
        #debug-text { font-size: 10px; color: #777; margin-top: 10px; word-break: break-all; }

    </style>
</head>
<body>

    <!-- 1. å¯åŠ¨é¡µ -->
    <div id="overlay">
        <h2 style="margin-bottom: 5px;">ğŸƒ å®¤å†…æ¼«æ­¥è€… V2</h2>
        <p style="font-size: 12px; color: #888; margin-bottom: 30px;">
            è¯·ç¡®ä¿æ‚¨åœ¨ HTTPS æˆ– Localhost ç¯å¢ƒä¸‹è¿è¡Œ<br>å¦åˆ™å®‰å“ä¼ æ„Ÿå™¨å¯èƒ½ä¸å·¥ä½œ
        </p>

        <button class="btn btn-blue" onclick="document.getElementById('fileInput').click()">ğŸ“‚ 1. é€‰æ‹©è§†é¢‘</button>
        <input type="file" id="fileInput" accept="video/*" style="display:none" onchange="onFileSelected(this)">
        
        <div id="file-info" style="color:#4CAF50; font-size:12px; height:20px; margin:5px 0;"></div>

        <button id="start-btn" class="btn" onclick="enterApp()" disabled>ğŸš€ 2. å…¨å±å¼€å§‹</button>
        
        <!-- æ— æ³•ä½¿ç”¨ä¼ æ„Ÿå™¨æ—¶çš„å¤‡ç”¨æ–¹æ¡ˆ -->
        <button onclick="testMotion()" style="background:transparent; border:1px solid #444; color:#666; font-size:12px; padding:5px 10px; border-radius:10px; margin-top:20px;">
            âš ï¸ ä¼ æ„Ÿå™¨æ²¡ååº”ï¼Ÿç‚¹æ­¤æ¨¡æ‹Ÿä¸€æ­¥
        </button>
    </div>

    <!-- 2. è§†é¢‘å±‚ -->
    <div id="video-wrapper">
        <video id="mainVideo" playsinline loop muted></video>
    </div>

    <!-- 3. HUD ç•Œé¢ (åŠé€æ˜è¦†ç›–) -->
    <div id="hud">
        <!-- å·¦ä¸Šï¼šé€Ÿåº¦ -->
        <div class="hud-top-left">
            <div><span class="speed-val" id="disp-speed">0.0</span> <span class="speed-unit">å€é€Ÿ</span></div>
            <div style="font-size: 12px; color: #aaa;" id="disp-kmh">0 km/h</div>
        </div>

        <!-- å³ä¸Šï¼šçŠ¶æ€ -->
        <div class="hud-top-right">
            <div><span class="sensor-dot" id="sensor-light"></span> <span id="disp-steps">0</span> æ­¥</div>
        </div>

        <!-- åº•éƒ¨ï¼šè®¾ç½®æŒ‰é’® -->
        <button class="controls-trigger" onclick="toggleSettings()">âš™ï¸ è®¾ç½® / è°ƒè¯•</button>

        <!-- åº•éƒ¨ï¼šè¿›åº¦æ¡ -->
        <div class="progress-wrapper">
            <div class="progress-fill" id="progress-bar"></div>
        </div>
    </div>

    <!-- 4. è®¾ç½®é¢æ¿ -->
    <div id="settings-modal">
        <h3 style="margin-top:0">è®¾ç½®</h3>
        
        <div class="setting-row">
            <label>ä¼ æ„Ÿå™¨çµæ•åº¦ (1-10, è¶Šå°è¶Šçµæ•)</label>
            <input type="range" id="sensitivity" min="1" max="10" value="3" oninput="updateVal('sens-val', this.value)">
            <span id="sens-val" style="float:right; font-size:12px;">3</span>
        </div>

        <div class="setting-row">
            <label>åŸè§†é¢‘å½•åˆ¶é€Ÿåº¦ (km/h)</label>
            <input type="number" id="base-speed" value="5">
        </div>
        
        <div class="setting-row">
            <label>VR è§†è§’æ ¡å‡†</label>
            <button onclick="recenterVR()" style="background:#333; color:white; border:1px solid #555; padding:5px 10px;">é‡ç½®å½“å‰æœå‘ä¸ºæ­£å‰æ–¹</button>
        </div>

        <div id="debug-text">ä¼ æ„Ÿå™¨æ•°æ®: ç­‰å¾…ä¸­...</div>

        <button class="btn close-btn" onclick="toggleSettings()">å…³é—­ / è¿”å›è¿åŠ¨</button>
    </div>

    <script>
        // --- æ ¸å¿ƒå˜é‡ ---
        const video = document.getElementById('mainVideo');
        const overlay = document.getElementById('overlay');
        const hud = document.getElementById('hud');
        const sensorLight = document.getElementById('sensor-light');
        const debugText = document.getElementById('debug-text');
        
        // è¿åŠ¨çŠ¶æ€
        let lastAcc = { x:0, y:0, z:0 };
        let lastTimestamp = 0;
        let speedMultiplier = 0;
        let targetMultiplier = 0;
        let stepCount = 0;
        let isMoving = false;
        let stopTimer = null;

        // VR çŠ¶æ€
        let initialAlpha = null; // åˆå§‹æ–¹å‘
        let currentAlpha = 0;
        let isLandscape = true;

        // é…ç½®
        let config = {
            sensitivity: 3, // é˜ˆå€¼ï¼Œè¶Šä½è¶Šå®¹æ˜“è§¦å‘
            decay: 0.05,    // å‡é€Ÿæƒ¯æ€§
            baseSpeed: 5,   // è§†é¢‘åŸºå‡†é€Ÿåº¦
            stepGain: 0.3   // æ¯ä¸€æ­¥å¢åŠ å¤šå°‘é€Ÿåº¦
        };

        // --- 1. æ–‡ä»¶ä¸å¯åŠ¨ ---
        function onFileSelected(input) {
            const file = input.files[0];
            if(file) {
                video.src = URL.createObjectURL(file);
                document.getElementById('file-info').innerText = "å·²åŠ è½½: " + file.name;
                document.getElementById('start-btn').disabled = false;

                // åˆ¤æ–­æ¨ªç«–å±
                video.onloadedmetadata = () => {
                    isLandscape = video.videoWidth > video.videoHeight;
                    // å¦‚æœæ˜¯æ¨ªå±è§†é¢‘ï¼Œä¸”åœ¨æ‰‹æœºç«–å±ä¸Šçœ‹ï¼Œå¼€å¯VRæ¨¡å¼ï¼ˆé«˜åº¦é“ºæ»¡ï¼‰
                    if(isLandscape) {
                        video.style.width = 'auto';
                        video.style.height = '100vh';
                    } else {
                        video.style.width = '100%';
                        video.style.height = '100%';
                    }
                };
            }
        }

        function enterApp() {
            // å°è¯•å…¨å±
            const docEl = document.documentElement;
            if (docEl.requestFullscreen) { docEl.requestFullscreen(); }
            else if (docEl.webkitRequestFullscreen) { docEl.webkitRequestFullscreen(); }

            // éšè—å¯åŠ¨é¡µï¼Œæ˜¾ç¤ºHUD
            overlay.style.display = 'none';
            hud.style.display = 'block';

            // æ’­æ”¾è§†é¢‘ï¼ˆåˆå§‹é€Ÿåº¦0ï¼‰
            video.play().then(() => {
                video.playbackRate = 0;
            }).catch(e => alert("æ’­æ”¾å¤±è´¥: " + e));

            // åˆå§‹åŒ–ä¼ æ„Ÿå™¨
            initSensors();
            
            // å¼€å¯ä¸»å¾ªç¯
            requestAnimationFrame(gameLoop);
        }

        // --- 2. ä¼ æ„Ÿå™¨é€»è¾‘ (æ ¸å¿ƒ) ---
        function initSensors() {
            // iOS æƒé™è¯·æ±‚
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission().then(response => {
                    if (response == 'granted') bindEvents();
                }).catch(console.error);
            } else {
                // Android / æ™®é€šæµè§ˆå™¨ç›´æ¥ç»‘å®š
                bindEvents();
            }
        }

        function bindEvents() {
            window.addEventListener('devicemotion', handleMotion);
            window.addEventListener('deviceorientation', handleOrientation);
        }

        function handleMotion(event) {
            // è·å–åŠ é€Ÿåº¦ (Androidä¸Šå¯èƒ½éœ€è¦accelerationIncludingGravity)
            let acc = event.acceleration;
            let accG = event.accelerationIncludingGravity;

            // å…¼å®¹æ€§å¤„ç†ï¼šå¦‚æœaccelerationå…¨æ˜¯nullï¼Œå°±ç”¨å¸¦é‡åŠ›çš„
            if(!acc || (acc.x === null && acc.y === null)) {
                acc = accG;
            }

            if(!acc) {
                debugText.innerText = "é”™è¯¯ï¼šæ— æ³•è·å–åŠ é€Ÿåº¦æ•°æ®";
                return;
            }

            // è°ƒè¯•æ˜¾ç¤º
            debugText.innerText = `X:${acc.x?.toFixed(1)} Y:${acc.y?.toFixed(1)} Z:${acc.z?.toFixed(1)}`;

            // è®¡ç®—éœ‡åŠ¨å¼ºåº¦ (ç®€å•çš„å‘é‡å·®å€¼)
            // å¦‚æœæ˜¯ç”¨acceleration (æ— é‡åŠ›)ï¼Œé™æ­¢æ˜¯0ã€‚
            // å¦‚æœæ˜¯ç”¨IncludingGravityï¼Œé™æ­¢æ˜¯9.8ã€‚
            
            let strength = 0;
            if (event.acceleration && event.acceleration.x !== null) {
                // çº¯åŠ é€Ÿåº¦ï¼Œç›´æ¥ç®—æ¨¡é•¿
                strength = Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2);
            } else {
                // å¸¦é‡åŠ›ï¼Œå‡å»é‡åŠ›
                const total = Math.sqrt(accG.x**2 + accG.y**2 + accG.z**2);
                strength = Math.abs(total - 9.8);
            }

            // é˜ˆå€¼åˆ¤æ–­
            const threshold = parseFloat(document.getElementById('sensitivity').value) || 3;

            if (strength > threshold) {
                triggerStep();
            }
        }

        // è§¦å‘ä¸€æ­¥
        function triggerStep() {
            const now = Date.now();
            if (now - lastTimestamp > 300) { // é˜²æŠ–ï¼Œä¸¤æ¬¡æ­¥ä¼è‡³å°‘é—´éš”300ms
                lastTimestamp = now;
                stepCount++;
                
                // è§†è§‰åé¦ˆ
                sensorLight.classList.add('sensor-active');
                setTimeout(() => sensorLight.classList.remove('sensor-active'), 150);
                
                document.getElementById('disp-steps').innerText = stepCount;

                // å¢åŠ é€Ÿåº¦å€ç‡ (æ¯æ¬¡è§¦å‘å¢åŠ ä¸€ç‚¹ï¼Œæœ€é«˜é™åˆ¶)
                // æ¯”å¦‚æ¯èµ°ä¸€æ­¥ï¼Œå€ç‡å¢åŠ åˆ° 1.5xï¼Œå¦‚æœä¸èµ°ï¼Œæ…¢æ…¢æ‰ä¸‹æ¥
                targetMultiplier = 1.5; 
                
                // å¦‚æœèµ°å¾—éå¸¸å¿«ï¼ˆé—´éš”çŸ­ï¼‰ï¼Œå€ç‡æ›´é«˜
                // è¿™é‡Œåšä¸€ä¸ªç®€å•é€»è¾‘ï¼šåªè¦åœ¨èµ°ï¼Œå°±ä¿æŒé€Ÿåº¦
                if (stopTimer) clearTimeout(stopTimer);
                stopTimer = setTimeout(() => {
                    targetMultiplier = 0; // 1.5ç§’æ²¡åŠ¨ï¼Œç›®æ ‡é€Ÿåº¦å½’é›¶
                }, 1500);
            }
        }

        // æ‰‹åŠ¨æµ‹è¯•æŒ‰é’® (ç”¨äºä¼ æ„Ÿå™¨å¤±æ•ˆæ—¶æµ‹è¯•)
        function testMotion() {
             alert("æ¨¡æ‹Ÿè§¦å‘äº†ä¸€æ­¥ï¼å¦‚æœæ²¡æœ‰ååº”ï¼Œè¯·æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†è§†é¢‘ã€‚");
             triggerStep();
             // å¼ºåˆ¶å¯åŠ¨
             if(overlay.style.display !== 'none') enterApp();
        }

        // VR è§†è§’é€»è¾‘
        function handleOrientation(event) {
            if (!isLandscape) return;
            
            // alpha: 0-360 æŒ‡å—é’ˆæ–¹å‘
            let alpha = event.alpha;
            if (alpha === null) return;

            if (initialAlpha === null) initialAlpha = alpha;

            // è®¡ç®—è§’åº¦å·® (-180 ~ 180)
            let delta = alpha - initialAlpha;
            if (delta > 180) delta -= 360;
            if (delta < -180) delta += 360;

            // æ˜ å°„åˆ°ä½ç§». å‡è®¾90åº¦ç§»åŠ¨50%
            // ä½¿ç”¨ CSS transform
            const movePercent = -(delta * 0.8); 
            video.style.transform = `translateX(${movePercent}%) scale(1.1)`;
        }

        function recenterVR() {
            initialAlpha = null; // ä¸‹ä¸€æ¬¡äº‹ä»¶ä¼šè‡ªåŠ¨é‡ç½®
        }

        // --- 3. æ¸¸æˆä¸»å¾ªç¯ (å¹³æ»‘å¤„ç†) ---
        function gameLoop() {
            // å¹³æ»‘å˜é€Ÿï¼šå½“å‰é€Ÿåº¦å‘ç›®æ ‡é€Ÿåº¦é è¿‘
            const diff = targetMultiplier - speedMultiplier;
            
            if (Math.abs(diff) > 0.01) {
                speedMultiplier += diff * config.decay; // æ¸å˜
            } else {
                speedMultiplier = targetMultiplier;
            }

            // æ›´æ–°è§†é¢‘æ’­æ”¾ç‡
            // åªæœ‰å½“å¤§äº0.1æ‰æ’­æ”¾ï¼Œå¦åˆ™æš‚åœä»¥èŠ‚çœèµ„æºæˆ–é¿å…é¬¼ç•œ
            if (speedMultiplier < 0.1) {
                if(!video.paused) video.pause(); // å®Œå…¨åœä¸‹
                speedMultiplier = 0;
            } else {
                if(video.paused) video.play();
                video.playbackRate = speedMultiplier;
            }

            // æ›´æ–°UIæ–‡å­—
            document.getElementById('disp-speed').innerText = speedMultiplier.toFixed(1);
            
            // ä¼°ç®— km/h
            const base = parseFloat(document.getElementById('base-speed').value);
            const realSpeed = base * speedMultiplier;
            document.getElementById('disp-kmh').innerText = realSpeed.toFixed(1) + " km/h";

            // æ›´æ–°è¿›åº¦æ¡
            if (video.duration) {
                const pct = (video.currentTime / video.duration) * 100;
                document.getElementById('progress-bar').style.width = pct + "%";
            }

            requestAnimationFrame(gameLoop);
        }

        // --- è¾…åŠ©åŠŸèƒ½ ---
        function toggleSettings() {
            const el = document.getElementById('settings-modal');
            el.style.display = (el.style.display === 'block') ? 'none' : 'block';
        }
        
        function updateVal(id, val) {
            document.getElementById(id).innerText = val;
        }

    </script>
</body>
</html>
